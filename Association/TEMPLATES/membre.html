<!-- TEMPLATES/membre.html -->
{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
    .dashboard-container { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; padding: 20px; }
    .dashboard-header h2 { font-weight: 700; color: #343a40; }
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 30px 0; }
    .kpi-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid; }
    .kpi-card .label { font-size: 0.9rem; color: #6c757d; text-transform: uppercase; font-weight: 600; }
    .kpi-card .value { font-size: 2rem; font-weight: 700; color: #343a40; }
    .card-total { border-color: #007bff; }
    .card-age { border-color: #ffc107; }
    .card-anciennete { border-color: #17a2b8; }
    .charts-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; margin-bottom: 30px; }
    .chart-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .chart-container img { max-width: 100%; height: auto; }
    .no-data-message { display: flex; justify-content: center; align-items: center; height: 300px; color: #6c757d; background-color: #f1f3f5; border-radius: 8px; }
    .table-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    
    @media (max-width: 992px) {
        .charts-grid { grid-template-columns: 1fr; }
    }
</style>

<div class="dashboard-container">
    <div class="dashboard-header">
        <h2>Member Management</h2>
    </div>

    {# Data Analysis Section #}
    {% if user.is_superuser %}
        <!-- KPIs -->
        <div class="kpi-grid">
            <div class="kpi-card card-total">
                <div class="label">Active Members</div>
                <div class="value">{{ kpi.total_membres|default:"0" }}</div>
            </div>
            <div class="kpi-card card-age">
                <div class="label">Average Age</div>
                <div class="value">{{ kpi.age_moyen|default:"N/A" }} <small>years</small></div>
            </div>
            <div class="kpi-card card-anciennete">
                <div class="label">Average Seniority</div>
                <div class="value">{{ kpi.anciennete_moyenne|default:"N/A" }} <small>years</small></div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-container">
                {% if chart_paths.sexe_chart %}
                    <img src="{% static chart_paths.sexe_chart %}" alt="Distribution by Gender">
                {% else %}
                    <div class="no-data-message"><p>Insufficient data for gender chart.</p></div>
                {% endif %}
            </div>
            <div class="chart-container">
                {% if chart_paths.engagement_chart %}
                    <img src="{% static chart_paths.engagement_chart %}" alt="Distribution by Marital Status">
                {% else %}
                    <div class="no-data-message"><p>Insufficient data for status chart.</p></div>
                {% endif %}
            </div>
        </div>
    {% endif %}

    {# --- Member List  --- #}
    <div class="table-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Association Member List</h3>
            {% if user.is_superuser %}
                <a href="{% url 'ajouter_membre' %}" class="btn btn-primary">Add Member</a>
            {% endif %}
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Last Name</th>
                        <th>First Name</th>
                        <th>Email</th>
                        <th>Entry Year</th>
                        <th>Tontines</th>
                        {% if user.is_superuser %}
                            <th>Actions</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for membre in membres %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ membre.nom }}</td>
                        <td>{{ membre.prenom }}</td>
                        <td>{{ membre.email }}</td>
                        <td>{{ membre.anneeEntree }}</td>
                        <td>
                            {% for t in membre.tontines.all %}
                                {{ t.nomTontines }}{% if not forloop.last %}, {% endif %}
                            {% empty %}
                                <span class="text-muted">None</span>
                            {% endfor %}
                        </td>
                        {% if user.is_superuser %}
                            <td>
                                <a href="{% url 'modifier_membre' membre.idMembre %}" class="btn btn-warning btn-sm">Edit</a>
                                <a href="{% url 'supprimer_membre' membre.idMembre %}" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure?');">Delete</a>
                            </td>
                        {% endif %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center">No members found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}